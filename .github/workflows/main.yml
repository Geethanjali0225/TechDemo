name: Airflow Deployment

on:
  push:
    branches:
      - main

jobs:
  deploy_airflow:
    runs-on: self-hosted

    env:
      KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG_DATA }}
      KUBE_CONTEXT: minikube
      HELM_CHART_REPO: https://airflow.apache.org
      HELM_RELEASE_NAME: airflow
      HELM_VALUES_FILE: values.yaml

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Identify Modified DAGs
      id: modified_dags
      run: |
        MODIFIED_DAGS=$(git diff --name-only ${{ github.sha }}^ ${{ github.sha }} | grep 'dags/.*\.py' || true)
        echo "Modified DAGs: $MODIFIED_DAGS"
        echo "::set-output name=modified_dags::$MODIFIED_DAGS"

    - name: Add Helm Repo & Update
      run: |
        helm repo add apache-airflow https://airflow.apache.org
        helm repo update

    - name: Get Airflow Pod Name
      id: get_pod_name
      run: |
        POD_NAME=$(kubectl get pods --namespace default -l "release=${{ env.HELM_RELEASE_NAME }}" -o jsonpath="{.items[0].metadata.name}")
        echo "::set-output name=pod_name::$POD_NAME"
      continue-on-error: true  # Ignore errors if no pod is found, as it might not be created yet.

    - name: Update Modified DAGs
      if: ${{ steps.modified_dags.outputs.modified_dags != '' }}
      run: |
        IFS=$'\n' read -rd '' -a DAGS <<<"${{ steps.modified_dags.outputs.modified_dags }}"
        for DAG in "${DAGS[@]}"; do
          echo "Updating DAG: $DAG"
          kubectl cp $DAG ${{ steps.get_pod_name.outputs.pod_name }}:/dags/$DAG
        done

    # - name: Upgrade Airflow
    #   run: |
    #     helm upgrade --install airflow apache-airflow/airflow -f values.yaml --debug
